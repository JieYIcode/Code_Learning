<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>高实用性代码收录: ROOT::RDataFrame</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Root6Icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">高实用性代码收录<span id="projectnumber">&#160;v0.1</span>
   </div>
   <div id="projectbrief">可读 实用 高效</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2C_09_09_2ROOT_1_1RDataFrame.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ROOT::RDataFrame</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md15"></a></p>
<p><code>ROOT::RDataFrame</code> 是 <code>ROOT</code> 数据处理框架（DataFrame）的现代接口，它类似于 Python 的 <code>pandas</code>，提供了一种更高效、更直观的数据处理方式。<code>RDataFrame</code> 支持数据筛选、累加、转换和可视化操作，并且能够通过多线程自动优化处理流程。</p>
<h1><a class="anchor" id="autotoc_md16"></a>
基本简介</h1>
<p><code>RDataFrame</code> 提供了一种面向数据处理的接口，通过链式操作可以轻松地对数据进行筛选、转换、分析和保存。与传统的 <code>TTree::Draw</code> 和 <code>TTree::Process</code> 不同，<code>RDataFrame</code> 能够更好地控制数据流，并且具有更高的灵活性和效率。</p>
<h2><a class="anchor" id="autotoc_md17"></a>
用法解释</h2>
<p>以代码片段为例，逐行解析 <code>RDataFrame</code> 的用法。</p>
<div class="fragment"><div class="line">ROOT::RDataFrame df(*mEventTree);</div>
</div><!-- fragment --><ol type="1">
<li><p class="startli"><b>创建 <code>RDataFrame</code> 对象：</b></p><ul>
<li>这行代码创建了一个 <code>RDataFrame</code> 实例 <code>df</code>，表示整个 <code>TTree</code> 或 <code>TChain</code>（<code>mEventTree</code>）。</li>
<li><code>RDataFrame</code> 的构造函数接受 <code>TTree</code> 或 <code>TChain</code> 的指针或引用，并从中读取数据。它类似于 <code>pandas</code> 中的 <code>DataFrame</code>，用于表示一个完整的数据表。</li>
</ul>
<p class="startli"><b>注意：</b> <code>mEventTree</code> 是一个 <code>TTree</code> 或 <code>TChain</code> 对象，应该已经链接了所有的 <code>ROOT</code> 文件。</p>
</li>
</ol>
<div class="fragment"><div class="line"><span class="keyword">auto</span> filtered = df.Filter(</div>
<div class="line">    [=](Short_t px, Short_t py, Int_t evt, Short_t lyr, Float_t x, Int_t fid) {</div>
<div class="line">        <span class="keywordflow">return</span> px == padWaferX &amp;&amp; py == padWaferY &amp;&amp; evt == iEvent &amp;&amp; lyr == layer &amp;&amp; x &gt; 0 &amp;&amp; fid == fileIdentifier;</div>
<div class="line">    },</div>
<div class="line">    {<span class="stringliteral">&quot;padWaferX&quot;</span>, <span class="stringliteral">&quot;padWaferY_1&quot;</span>, <span class="stringliteral">&quot;iEvent&quot;</span>, <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;fileIdentifier&quot;</span>} <span class="comment">// 使用的变量名称应与树中分支名称一致</span></div>
<div class="line">);</div>
</div><!-- fragment --><ol type="1">
<li><b>数据筛选 (<code>Filter</code>)：</b><ul>
<li><code>Filter</code> 是 <code>RDataFrame</code> 中用于筛选数据的函数，它会根据用户定义的条件从 <code>df</code> 中筛选出符合条件的条目，返回一个新的 <code>RDataFrame</code> 对象 <code>filtered</code>。</li>
<li><code>Filter</code> 函数的参数：<ul>
<li>第一个参数是一个 Lambda 函数 <code>[=](Short_t px, Short_t py, Int_t evt, Short_t lyr, Float_t x, Int_t fid)</code>，用于判断每个条目是否符合筛选条件。</li>
<li>Lambda 函数内部的条件判断：<code>px == padWaferX &amp;&amp; py == padWaferY &amp;&amp; evt == iEvent &amp;&amp; lyr == layer &amp;&amp; x &gt; 0 &amp;&amp; fid == fileIdentifier</code>。如果返回 <code>true</code>，则表示该条目满足条件，会被保留在 <code>filtered</code> 中；否则，该条目会被过滤掉。</li>
</ul>
</li>
<li>第二个参数是一个字符串列表 <code>{"padWaferX", "padWaferY_1", "iEvent", "layer", "x", "fileIdentifier"}</code>，表示需要从 <code>df</code> 中读取的分支（<code>TBranch</code>）名称。<ul>
<li><code>RDataFrame</code> 会自动将这些分支的值传递给 Lambda 函数中的参数 <code>px</code>, <code>py</code>, <code>evt</code>, <code>lyr</code>, <code>x</code>, <code>fid</code>。</li>
<li>Lambda 函数中的参数顺序和分支名顺序必须一致，并且类型匹配（<code>Short_t</code>, <code>Int_t</code>, <code>Float_t</code>等）。</li>
</ul>
</li>
</ul>
</li>
</ol>
<div class="fragment"><div class="line"><span class="keyword">auto</span> totalEnergy = filtered.Sum&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;depEn&quot;</span>);</div>
</div><!-- fragment --><ol type="1">
<li><b>计算能量总和 (<code>Sum</code>)：</b><ul>
<li><code>Sum</code> 是 <code>RDataFrame</code> 中的一个聚合函数，用于计算某个分支（列）的累加值。</li>
<li><code>filtered.Sum&lt;float&gt;("depEn")</code> 表示计算 <code>filtered</code> 中所有符合条件条目中 <code>depEn</code> 分支（表示能量）的总和，并返回一个指向累加结果的指针 <code>totalEnergy</code>。</li>
<li><code>Sum</code> 的模板参数 <code>&lt;float&gt;</code> 表示 <code>depEn</code> 分支的类型为 <code>float</code>，与 <code>TTree</code> 中的 <code>depEn</code> 类型保持一致。</li>
</ul>
</li>
</ol>
<div class="fragment"><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Total deposited energy: &quot;</span> &lt;&lt; *totalEnergy / 1e9 &lt;&lt; <span class="stringliteral">&quot; GeV&quot;</span> &lt;&lt; std::endl;</div>
</div><!-- fragment --><ol type="1">
<li><b>获取和输出总能量：</b><ul>
<li><code>totalEnergy</code> 是一个 <code>RResultPtr</code>（类似于指针），它指向 <code>Sum</code> 计算的结果。</li>
<li><code>*totalEnergy</code> 解引用 <code>RResultPtr</code>，获得 <code>depEn</code> 的累加值。</li>
<li>输出能量总和，并将其单位从 <code>eV</code> 转换为 <code>GeV</code>（1 GeV = 1e9 eV）。</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md18"></a>
常用操作</h1>
<p>以下是 <code>RDataFrame</code> 的一些常用操作，帮助你更好地理解其用法：</p>
<ol type="1">
<li>**创建 RDataFrame 对象**： <div class="fragment"><div class="line">ROOT::RDataFrame df(<span class="stringliteral">&quot;treeName&quot;</span>, <span class="stringliteral">&quot;filename.root&quot;</span>);</div>
</div><!-- fragment --><ul>
<li><code>df</code> 表示名为 <code>"treeName"</code> 的 <code>TTree</code>，来自 <code>filename.root</code> 文件。</li>
</ul>
</li>
<li>**筛选数据 (<code>Filter</code>)**： <div class="fragment"><div class="line"><span class="keyword">auto</span> filtered_df = df.Filter(<span class="stringliteral">&quot;x &gt; 0 &amp;&amp; y &lt; 0&quot;</span>); <span class="comment">// 根据字符串条件筛选</span></div>
<div class="line"><span class="keyword">auto</span> filtered_df = df.Filter([](<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y) { <span class="keywordflow">return</span> x &gt; 0 &amp;&amp; y &lt; 0; }, {<span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>}); <span class="comment">// 根据 Lambda 函数筛选</span></div>
</div><!-- fragment --><ul>
<li>筛选条件可以是字符串表达式或 Lambda 函数。</li>
<li>Lambda 函数参数列表中的变量类型必须与 <code>TTree</code> 中的分支类型匹配。</li>
</ul>
</li>
<li>**定义新变量 (<code>Define</code>)**： <div class="fragment"><div class="line"><span class="keyword">auto</span> df_with_new_col = df.Define(<span class="stringliteral">&quot;newCol&quot;</span>, <span class="stringliteral">&quot;x + y&quot;</span>); <span class="comment">// 根据字符串表达式定义新变量</span></div>
<div class="line"><span class="keyword">auto</span> df_with_new_col = df.Define(<span class="stringliteral">&quot;newCol&quot;</span>, [](<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y) { <span class="keywordflow">return</span> x + y; }, {<span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>}); <span class="comment">// 根据 Lambda 函数定义新变量</span></div>
</div><!-- fragment --><ul>
<li><code>Define</code> 可以根据已有分支定义新的变量，返回一个新的 <code>RDataFrame</code>。</li>
</ul>
</li>
<li>**聚合操作**：<ul>
<li><code>Sum</code>：累加某个分支的值。 <div class="fragment"><div class="line"><span class="keyword">auto</span> sum_value = df.Sum&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Sum of x: &quot;</span> &lt;&lt; *sum_value &lt;&lt; std::endl;</div>
</div><!-- fragment --></li>
<li><code>Mean</code>：计算某个分支的平均值。 <div class="fragment"><div class="line"><span class="keyword">auto</span> mean_value = df.Mean(<span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Mean of x: &quot;</span> &lt;&lt; *mean_value &lt;&lt; std::endl;</div>
</div><!-- fragment --></li>
<li><code>Min/Max</code>：求最小值或最大值。 <code>cpp auto min_value = df.Min("x"); auto max_value = df.Max("x"); std::cout &lt;&lt; "Min of x: " &lt;&lt; *min_value &lt;&lt; ", Max of x: " &lt;&lt; *max_value &lt;&lt; std::endl; </code></li>
</ul>
</li>
<li>**绘图 (<code>Histo</code>)**： <div class="fragment"><div class="line"><span class="keyword">auto</span> hist = df.Histo1D(<span class="stringliteral">&quot;x&quot;</span>); <span class="comment">// 创建 x 的一维直方图</span></div>
<div class="line">hist-&gt;Draw();</div>
</div><!-- fragment --><ul>
<li><code>Histo1D</code>、<code>Histo2D</code> 等函数可以直接绘制一维或二维直方图。</li>
</ul>
</li>
<li>**保存筛选后的数据 (<code>Snapshot</code>)**： <div class="fragment"><div class="line">filtered_df.Snapshot(<span class="stringliteral">&quot;newTreeName&quot;</span>, <span class="stringliteral">&quot;newFileName.root&quot;</span>);</div>
</div><!-- fragment --><ul>
<li>将筛选或处理后的数据保存到新的 <code>ROOT</code> 文件或 <code>TTree</code> 中。</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md19"></a>
注意事项</h2>
<ol type="1">
<li>**类型匹配**：<ul>
<li><code>RDataFrame</code> 中 Lambda 函数的参数类型必须与 <code>TTree</code> 中的分支类型匹配。否则会报错：<code>TTreeReaderValueBase::CreateProxy()</code> 类型不匹配。</li>
</ul>
</li>
<li>**分支名称必须一致**：<ul>
<li><code>Filter</code> 和 <code>Define</code> 函数中引用的分支名称（字符串）必须与 <code>TTree</code> 中的分支名称完全一致（区分大小写），否则会导致无法正确访问数据。</li>
</ul>
</li>
<li>**使用 <code>ROOT</code> 的多线程支持**：<ul>
<li>可以通过 <code>EnableImplicitMT()</code> 开启多线程支持，提升 <code>RDataFrame</code> 的处理效率： <div class="fragment"><div class="line">ROOT::EnableImplicitMT();</div>
</div><!-- fragment --></li>
<li>这行代码放在 <code>RDataFrame</code> 使用之前，将自动使用多线程处理数据。</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md20"></a>
总结</h2>
<p><code>RDataFrame</code> 提供了类似 <code>pandas</code> 的数据处理接口，是一种高效、直观的数据处理方式。它的核心思想是链式操作，通过 <code>Filter</code>、<code>Define</code>、<code>Sum</code>、<code>Mean</code> 等函数一步步对数据进行筛选、转换和聚合，并在整个过程中保持数据流的连贯性。如果你熟悉 Python 的 <code>pandas</code> 或 SQL 的操作方式，<code>RDataFrame</code> 会非常容易上手。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.0 </li>
  </ul>
</div>
</body>
</html>
